1. 가급적 idempotent하게 짤 것. 무슨 일에서건 중복 호출은 발생할 수 있기 때문에  
2. one-off script를 주기적으로 실행해야 한다면 트레이딩 시스템 밖의 cron job으로 빼낼 것  

## 시스템 4요소
클라이언트 4요소 : 잔고손익, 주문체결, 호가창, 매매 파라미터 조작 창
트레이딩 시스템 4요소 : OMS(주문), EMS(체결), 로직, 로깅 +(시세)

## MEV  

### multi hop arb  

### liquidation  

### sandwich attack  

## 국장

###  국장 매매 시스템 만드는 순서

- 마스터 받아오기 (종목 정보)
- 시세 피드 받아오기
- 잔고 api가 있으면 잔고 가져오기
- 잔고 api가 없다면 주문과 체결로 잔고를 만들어야 함. 오버나잇하는 잔고는 저장해두었다가, 장이 시작하면 다시 불러와야 함
- 주문은 신규, 정정, 취소를 기본으로
- 기타 주문 방법과 자전거래방지코드 등 세부 사항은 전략의 세밀함에 따라 조정할 것
- 같은 종목에 대해 매수와 매도를 동시에 내는 경우 자전 거래를 조심할 것

### 한국 거래소의 규칙들
- 내가 보낸 주문의 응답은 반드시 순서대로, 1개씩 온다.
    - 순서가 엉키는 이유는 다른 시장 참여자의 액션으로 발생하는 '체결' 뿐이다.
- 정정 주문에 대해서 여러 번 컨펌이 들어올 수 있나?
    - 불가능함. 정정, 취소에 대한 응답은 한 번의 컨펌, 혹은 한 번의 거절만 가능함.
- 매칭 엔진에 넣기 전 컨펌, 거부를 보내고 그 다음에야 체결이 가능함.
    - 즉, 신규 주문 -> 체결 -> 컨펌은 불가능함. 신규 주문 -> 컨펌|거부 -> 체결 만이 가능함.
    - 물론, 원주문(a)의 정정 주문(b)의 정정 주문(c)을 보냈는데 정정 주문(c) 의 컨펌이 오기 전 정정 주문 b의 체결이 오는 건 가능하다.

### 가원장 몇가지 규칙들
-  신규 매수 주문(a) -> a 주문 전량 취소(b) -> 컨펌(b) -> 컨펌(a)
    - 불가능함. 거래소에서 주문은 들어온 순서대로 처리하니까 불가능 함.
    - "주문은 보낸 순서대로 컨펌이 들어온다"
- 주문을 지우는 타이밍은 전략마다 다름. 그러나 확실한 건, 전송시에 주문 complete의 요건을 충족했다고 하더라도 지우면 안됨
    - 거부, 일부 정정(의도한 정정 수량과 실 정정 수량이 다름), 일부 취소(의도한 취소 수량과 실 취소 수량이 다름)의 경우 롤백을 해야 함.
-  정정 주문의 정정 주문은 가능합니다. 그런데 취소의 취소 주문도 가능한가?
    - 생각해보면 저런 행동은 무익하다. 거래소는 순서대로 처리하므로 후자의 취소 주문이 유효할 수 있는 상황이 없다.
    - 먼저의 취소 주문이 컨펌되면, 이미 취소가 되었으므로 후자의 취소 주문은 거부가 날 것이고
    - 만약 전자의 취소가 거부 난다면 후자의 취소가 취소하려던 대상인 전자 취소 주문은 무효하기 때문이다.
    - 결론적으로 취소는 재귀적으로 주문을 발생시킬 수 없고 오로지 단 건만 존재한다.
- 장 전에 잔고를 증권사에서 넣어준다. 그 이후로 동기화는 없다. DMA만 하던가, HTS로만 해야 한다.
    - 동기화 이후 매매를 해보고, 현재 잔고와 주문의 상태를 HTS로 조회해야 한다.
